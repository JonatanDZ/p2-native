<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main</title>
    <link rel="stylesheet" href="/public/css/global.css" />
    <link rel="stylesheet" href="/public/css/components/product.css" />
    <!--Nedestående skal være i sin egen css fil?-->
    <style>
      .image-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin: 20px 0;
      }

      .image-container .card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 13%;
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .image-container .card:hover {
        transform: scale(1.05);
      }

      .image-container .card img {
        width: 100%;
        height: 300px;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="navbar"></div>
      <div>
        <h1>Anbefalede produkter</h1>
        <div class="image-container" id="recommendations">
          <!-- images will be displayed here -->
        </div>

        <h1>Nyeste produkter</h1>
        <div class="image-container" id="products">
          <!-- images will be displayed here -->
        </div>

        <!--<h1>Recent</h1>
        <div class="image-container" id="recent">
           images will be displayed here
        </div> -->
      </div>
      <div id="footer"></div>

      <script src="/public/js/components/navbar.js"></script>
      <script src="/public/js/components/footer.js"></script>
      <!--Nedestående skal være i sin egen js fil?-->
      <script>
        let frontpageAmount = 5;
        fetch("/get-products")
          .then((res) => res.json())
          .then((data) => {
            ///////////
            fetch("http://localhost:3000/recommend", {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            })
              .then((res) => res.json())
              .then((data1) => {
                ///////////
                const renderProducts = (containerId, listOfPrints) => {
                  const container = document.getElementById(containerId);
                  if (!container) return;

                  container.innerHTML = "";

                  data.forEach((product) => {
                    //Chooses top 5
                    for (
                      let i = 0;
                      i <
                      (data.length >= frontpageAmount
                        ? frontpageAmount
                        : data.length);
                      i++
                    ) {
                      //If id is in reccomended top 5, then make product
                      if (product.ID == listOfPrints[i].ID) {
                        const card = document.createElement("div");
                        card.className = "card";

                        const img = document.createElement("img");
                        img.src = product.picture;
                        img.alt = product.name;

                        const title = document.createElement("h3");
                        title.textContent = product.name;

                        const price = document.createElement("p");
                        price.textContent = `${product.price} DKK`;

                        const button = document.createElement("button");
                        button.className = "add-to-basket";
                        button.dataset.id = product.ID;
                        button.textContent = "Tilføj til kurv";

                        card.appendChild(img);
                        card.appendChild(title);
                        card.appendChild(price);
                        card.appendChild(button);
                        container.appendChild(card);
                      }
                    }
                  });
                };
                //Find the latest products
                let last = [];
                for (let i = 0; i < frontpageAmount; i++) {
                  last[i] = data[data.length - 1 - i];
                }
                renderProducts("recommendations", data1);
                renderProducts("products", last);
                //renderProducts("recent");

                document.body.addEventListener("click", function (e) {
                  if (
                    e.target &&
                    e.target.classList.contains("add-to-basket")
                  ) {
                    e.preventDefault();

                    const productId = parseInt(e.target.dataset.id);
                    const product = data.find((p) => p.ID === productId);

                    if (product) {
                      let basket =
                        JSON.parse(localStorage.getItem("basket")) || [];
                      const existingProduct = basket.find(
                        (item) => item.ID === product.ID
                      );
                      if (existingProduct) {
                        existingProduct.quantity =
                          (existingProduct.quantity || 1) + 1;
                      } else {
                        product.quantity = 1;
                        basket.push(product);
                      }
                      localStorage.setItem("basket", JSON.stringify(basket));
                      alert("Produktet er tilføjet til kurven!");
                    }
                  }
                });
              })
              .catch((err) =>
                console.error("Failed to load recommended list:", err)
              );
            /////////////////
          })
          .catch((err) =>
            console.error("Failed to load dynamic product data:", err)
          );
      </script>
    </main>
  </body>
</html>
