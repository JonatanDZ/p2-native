<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main</title>
    <link rel="stylesheet" href="/public/css/global.css" />
    <link rel="stylesheet" href="/public/css/components/product.css" />
    <!--Nedestående skal være i sin egen css fil?-->
    <style>
      .image-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin: 20px 0;
      }

      .image-container .card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 13%;
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .image-container .card:hover {
        transform: scale(1.05);
      }

      .image-container .card img {
        width: 100%;
        height: 300px;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="navbar"></div>
      <div>
        <h1>Events</h1>
        <div class="image-container" id="events">
          <!-- images will be displayed here -->
        </div>

        <h1>Anbefalede produkter</h1>
        <div class="image-container" id="recommendations"></div>

        <h1>Nyeste produkter</h1>
        <div class="image-container" id="products">
          <!-- images will be displayed here -->
        </div>
      </div>
      <div id="footer"></div>

      <script src="/public/js/components/navbar.js"></script>
      <script src="/public/js/components/footer.js"></script>
      <!--Nedestående skal være i sin egen js fil?-->
      <script>
        /*   let frontpageAmount = 5;
                //Products:
                fetch("/get-products")
                  .then((res) => res.json())
                  .then((data) => {
                    ///////////
                    fetch("http://localhost:3000/recommend", {
                      method: "GET",
                      headers: { "Content-Type": "application/json" },
                    })
                      .then((res) => res.json())
                      .then((data1) => {
                        ///////////
                        const renderProducts = (containerId, listOfPrints) => {
                          const container = document.getElementById(containerId);
                          if (!container) return;

                          container.innerHTML = "";

                          data.forEach((product) => {
                            //Chooses the right amount of product unless there are fewer
                            for (
                              let i = 0;
                              i <
                              (data.length >= frontpageAmount
                                ? frontpageAmount
                                : data.length);
                              i++
                            ) {
                              //If id is in reccomended top 5, then make product
                              if (product.ID == listOfPrints[i].ID) {
                                const card = document.createElement("div");
                                card.className = "card";

                                const img = document.createElement("img");
                                img.src = product.picture;
                                img.alt = product.name;

                                const title = document.createElement("h3");
                                title.textContent = product.name;

                                const price = document.createElement("p");
                                price.textContent = `${product.price} DKK`;

                                const button = document.createElement("button");
                                button.className = "add-to-basket";
                                button.dataset.id = product.ID;
                                button.textContent = "Tilføj til kurv";

                                card.appendChild(img);
                                card.appendChild(title);
                                card.appendChild(price);
                                card.appendChild(button);
                                container.appendChild(card);
                              }
                            }
                          });
                        };
                        //Find the latest products
                        let last = [];
                        for (let i = 0; i < frontpageAmount; i++) {
                          last[i] = data[data.length - 1 - i];
                        }
                        renderProducts("recommendations", data1);
                        renderProducts("products", last);
                        //renderProducts("recent");

                        document.body.addEventListener("click", function (e) {
                          if (
                            e.target &&
                            e.target.classList.contains("add-to-basket")
                          ) {
                            e.preventDefault();

                            const productId = parseInt(e.target.dataset.id);
                            const product = data.find((p) => p.ID === productId);

                            if (product) {
                              let basket =
                                JSON.parse(localStorage.getItem("basket")) || [];
                              const existingProduct = basket.find(
                                (item) => item.ID === product.ID
                              );
                              if (existingProduct) {
                                existingProduct.quantity =
                                  (existingProduct.quantity || 1) + 1;
                              } else {
                                product.quantity = 1;
                                basket.push(product);
                              }
                              localStorage.setItem("basket", JSON.stringify(basket));
                              alert("Produktet er tilføjet til kurven!");
                            }
                          }
                        });
                      })
                      .catch((err) =>
                        console.error("Failed to load recommended list:", err)
                      );
                    /////////////////
                  })
                  .catch((err) =>
                    console.error("Failed to load dynamic product data:", err)
                  );
                //Events:
                fetch("/get-events")
                  .then((res) => res.json())
                  .then((data) => {
                    /////////////////////////////////////////////////////////////////////////////
                    fetch("http://localhost:3000/event-recommend", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ userID: 2 }),
                    })
                      .then((res) => res.json())
                      .then((data1) => {
                        console.log("EVENTS-RECOMMENDED", data1);
                        console.log("EVENTS", data);
                        ///////////
                        const renderEvents = (containerId, listOfPrints) => {
                          const container = document.getElementById(containerId);
                          if (!container) return;

                          container.innerHTML = "";

                          data.forEach((event) => {
                            //Chooses the right amount of product unless there are fewer
                            for (
                              let i = 0;
                              i <
                              (data.length >= frontpageAmount
                                ? frontpageAmount
                                : data.length);
                              i++
                            ) {
                              //If id is in reccomended top 5, then make event
                              if (event.ID == listOfPrints[i][1]) {
                                const card = document.createElement("div");
                                card.className = "card p-3";
                                card.style.width = "18rem";

                                const title = document.createElement("h4");
                                title.textContent = event.name || "Untitled Event";
                                const img = document.createElement("img");
                                img.src = event.image || "";
                                img.alt = event.name || "Event image";
                                img.style.width = "200px";
                                img.style.height = "250px";
                                img.style.objectFit = "cover";
                                img.style.objectPosition = "center";

                                card.appendChild(img);

                                const place = document.createElement("p");
                                place.innerHTML = `<strong>Place:</strong> ${
                                  event.place || "Unknown"
                                }`;

                                const time = document.createElement("p");
                                time.innerHTML = `<strong>Time:</strong> ${
                                  event.time || "TBD"
                                }`;

                                const price = document.createElement("p");
                                price.innerHTML = `<strong>Price:</strong> ${
                                  event.price || "N/A"
                                },-`;

                                const info = document.createElement("p");
                                info.innerHTML = `<strong>Info:</strong> ${
                                  event.info || "No info available"
                                }`;

                                const button = document.createElement("button");
                                button.className = "btn btn-primary event-link";
                                button.dataset.id = event.ID;
                                button.textContent = "View Event";

                                card.appendChild(title);
                                card.appendChild(place);
                                card.appendChild(time);
                                card.appendChild(price);
                                card.appendChild(info);
                                card.appendChild(button);

                                container.appendChild(card);
                              }
                            }
                          });
                          // Add click listeners to each event card button
                          container.addEventListener("click", function (e) {
                            if (e.target && e.target.classList.contains("event-link")) {
                              e.preventDefault();
                              const eventId = parseInt(
                                e.target.getAttribute("data-id")
                              );
                              const event = data.find((ev) => ev.ID === eventId);
                              if (event) {
                                console.log("CLICKED!");

                                const userID = 2; //Insert userID here (somehow)
                                console.log("USER", userID, "EVENT", eventId);
                                //Make a POST with userID and eventID
                                try {
                                  const response = fetch(
                                    "http://localhost:3000/event-detail",
                                    {
                                      method: "POST",
                                      headers: { "Content-Type": "application/json" },
                                      body: JSON.stringify({ userID, eventId }),
                                    }
                                  );
                                } catch (err) {
                                  console.error("Error:", err);
                                  alert("Something went wrong. Try again.");
                                }
                                addToUserEvents(event);
                              }
                            }
                          });
                        };
                        //Find the latest products
                        let last = [];
                        for (let i = 0; i < frontpageAmount; i++) {
                          last[i] = data[data.length - 1 - i];
                        }
                        renderEvents("events", data1);
                        //renderProducts("recent");

                        document.body.addEventListener("click", function (e) {
                          if (
                            e.target &&
                            e.target.classList.contains("add-to-basket")
                          ) {
                            e.preventDefault();

                            const productId = parseInt(e.target.dataset.id);
                            const product = data.find((p) => p.ID === productId);

                            if (product) {
                              let basket =
                                JSON.parse(localStorage.getItem("basket")) || [];
                              const existingProduct = basket.find(
                                (item) => item.ID === product.ID
                              );
                              if (existingProduct) {
                                existingProduct.quantity =
                                  (existingProduct.quantity || 1) + 1;
                              } else {
                                product.quantity = 1;
                                basket.push(product);
                              }
                              localStorage.setItem("basket", JSON.stringify(basket));
                              alert("Produktet er tilføjet til kurven!");
                            }
                          }
                        });
                      })
                      .catch((err) =>
                        console.error("Failed to load recommended list:", err)
                      );
                    /////////////////
                  })
                  .catch((err) =>
                    console.error("Failed to load dynamic product data:", err)
                  );
        */
        ///////////////////////////////////////////////////////////////////////////////////////////////////////
        async function getUserId() {
          // Get token from localStorage
          const token =
            localStorage.getItem("token") || sessionStorage.getItem("token");

          if (!token) {
            console.warn("No token found");
            return null;
          }

          try {
            // Send POST request to server to verify authentication and admin status
            const response = await fetch("/verify-token", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ token: token }),
            });

            const data = await response.json();

            return await data.userId;
          } catch (err) {
            // Handle fetch errors or server issues
            console.error("Error verifying token:", err);
            localStorage.removeItem("token");
            window.location.href = "/public/pages/login/login.html";
          }
        }

        async function getRecommendedItemsHTML() {
          const userId = await getUserId();

          await fetch(`/recommendItems?userId=${userId}`)
            .then((response) => response.json())
            .then((data) => {
              console.log("Recommendations:", data);
              displayRecommendedItems(data, "recommendations");
            })
            .catch((err) => {
              console.error("Failed to load recommendations:", err);
            });
        }

        async function getRecommendedEventsHTML() {
          const userId = await getUserId();

          await fetch(`/recommendEvents?userId=${userId}`)
            .then((response) => response.json())
            .then((data) => {
              console.log("Recommendations Events:", data);
              displayRecommendedEvents(data, "events");
            })
            .catch((err) => {
              console.error("Failed to load recommendations:", err);
            });
        }

        async function displayRecommendedItems(recommendationList, placement) {
          const top10 = recommendationList.slice(0, 10);

          if (top10.length > 0) {
            const allRes = await fetch("/get-products");
            const allProducts = await allRes.json();

            const container = document.getElementById(placement);
            container.innerHTML = ""; // clear previous content if any
            for (const rec of top10) {
              const product = allProducts.find((p) => p.ID === rec.ID);
              if (!product) continue;
              const card = document.createElement("div");
              card.className = "card";

              const img = document.createElement("img");
              img.src = product.picture;
              img.alt = product.name;

              const title = document.createElement("h3");
              title.textContent = product.name;

              const price = document.createElement("p");
              price.textContent = `${product.price} DKK`;

              const button = document.createElement("button");
              button.className = "add-to-basket";
              button.dataset.id = product.ID;
              button.textContent = "Tilføj til kurv";

              card.appendChild(img);
              card.appendChild(title);
              card.appendChild(price);
              card.appendChild(button);
              container.appendChild(card);
            }
            document.body
              .addEventListener("click", function (e) {
                if (e.target && e.target.classList.contains("add-to-basket")) {
                  e.preventDefault();

                  const productId = parseInt(e.target.dataset.id);
                  const product = allProducts.find((p) => p.ID === productId);

                  if (product) {
                    let basket =
                      JSON.parse(localStorage.getItem("basket")) || [];
                    const existingProduct = basket.find(
                      (item) => item.ID === product.ID
                    );
                    if (existingProduct) {
                      existingProduct.quantity =
                        (existingProduct.quantity || 1) + 1;
                    } else {
                      product.quantity = 1;
                      basket.push(product);
                    }
                    localStorage.setItem("basket", JSON.stringify(basket));
                    alert("Produktet er tilføjet til kurven!");
                  }
                }
              })
              .catch((err) =>
                console.error("Failed to load recommended list:", err)
              );
          } else {
            const container = document.getElementById(placement);
            container.innerHTML = ""; // clear previous content if any

            const itemHTML = document.createElement("div");
            itemHTML.innerHTML = `
                            <h3>Login for at se dine anbefalede varer</h3>
                        `;
            container.appendChild(itemHTML);
          }
        }

        async function getNewItems() {
          const allRes = await fetch("/get-products");
          const allProducts = await allRes.json();
          displayRecommendedItems(allProducts, "products");
        }

        async function getNewEvents() {
          const allRes = await fetch("/get-products");
          const allProducts = await allRes.json();
          displayRecommendedEvents(allProducts, "events");
        }

        async function displayRecommendedEvents(recommendationList, placement) {
          const top10 = recommendationList.slice(0, 5);

          if (top10.length > 0) {
            const allRes = await fetch("/get-events");
            const allEvents = await allRes.json();

            const container = document.getElementById(placement);
            container.innerHTML = ""; // clear previous content if any

            for (const rec of top10) {
              const event = allEvents.find((p) => p.ID === rec.ID);
              if (!event) continue;

              const card = document.createElement("div");
              card.className = "card p-3";
              card.style.width = "18rem";

              const title = document.createElement("h4");
              title.textContent = event.name || "Ingen event titel";
              const img = document.createElement("img");
              img.src = event.image || "";
              img.alt = event.name || "Event image";
              img.style.width = "250px";
              img.style.height = "250px";
              img.style.objectFit = "cover";
              img.style.objectPosition = "center";

              card.appendChild(img);

              const place = document.createElement("p");
              place.innerHTML = `<strong>Sted:</strong> ${
                event.place || "Ukendt"
              }`;

              const time = document.createElement("p");
              time.innerHTML = `<strong>Tid:</strong> ${event.time || "TBD"}`;

              const price = document.createElement("p");
              price.innerHTML = `<strong>Pris:</strong> ${
                event.price || "N/A"
              },-`;

              const info = document.createElement("p");
              info.innerHTML = `<strong>Info:</strong> ${
                event.info || "Ingen info tilgængelig"
              }`;

              const button = document.createElement("button");
              button.className = "btn btn-primary event-link";
              button.dataset.id = event.ID;
              button.textContent = "Se event";

              card.appendChild(title);
              card.appendChild(place);
              card.appendChild(time);
              card.appendChild(price);
              card.appendChild(info);
              card.appendChild(button);

              container.appendChild(card);
            }
          } else {
            const container = document.getElementById(placement);
            container.innerHTML = ""; // clear previous content if any

            const itemHTML = document.createElement("div");
            itemHTML.innerHTML = `
                            <h3>Login for at se dine anbefalede varer</h3>
                        `;
            container.appendChild(itemHTML);
          }
        }

        getRecommendedItemsHTML();
        getNewItems();
        getNewEvents();

        function addToBasket(product) {
          let basket = JSON.parse(localStorage.getItem("basket")) || [];
          const existingProduct = basket.find((item) => item.id === product.id);
          if (existingProduct) {
            existingProduct.quantity = (existingProduct.quantity || 1) + 1;
          } else {
            product.quantity = 1;
            basket.push(product);
          }
          localStorage.setItem("basket", JSON.stringify(basket));
          alert("Produktet er tilføjet til kurven!");
        }
      </script>
    </main>
  </body>
</html>
